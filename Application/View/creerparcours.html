<!DOCTYPE html>
<html lang="fr">
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css">
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <title>MAP</title>
</head>
<body>
<div id="map" style="height: 500px;"></div>
<div id="buttons">
  <button id="clearRoute">Effacer l'itineraire</button>
  <button id="removeLastMarker">Supprimer le dernier marqueur</button>
</div>
</div>

<div id="formContainer">
  <h2>Informations</h2>
  <form id="locationForm" method="post">
    <label for="city">Ville:</label>
    <input type="text" id="city" name="city" required><br>

    <label for="name">Nom:</label>
    <input type="text" id="name" name="name" required><br>

    <label for="year">Annee:</label>
    <input type="number" id="year" name="year" required><br>

    <button id="btn" >Enregistrer le parcours</button>
  </form>
</div>
<script>


  var latitude = 50.3965;
  var longitude = 3.6695;
  var map = L.map('map').setView([latitude, longitude], 13);

  document.getElementById('btn').addEventListener('click', function () {
    const ourForm = document.getElementById("formContainer");
    let p = document.createElement('input','text');
    p.setAttribute('name','markers');
    //p.setAttribute('visibility','hidden');
    //création d'un dictionnaire contenant l'ensemble des markers par leurs longitude et leurs latitude.
    var theMarkers = [];
    for(var i=0;i<markers.length;i++){
      theMarkers.push({ lat: markers[i].getLatLng().lat, long: markers[i].getLatLng().lng });    }
    p.value = JSON.parse(theMarkers);
    ourForm.add(p);
  });
  function saveParcours(){
    //e.preventDefault(); // Empêche l'envoi du formulaire par défaut

    // Récupération des valeurs du formulaire
    var city = document.getElementById('city').value;
    var name = document.getElementById('name').value;
    var year = document.getElementById('year').value;

    //création d'un dictionnaire contenant l'ensemble des markers par leurs longitude et leurs latitude.
    var theMarkers = [];
    for(var i=0;i<markers.length;i++){
      theMarkers.push({ lat: markers[i].getLatLng().lat, long: markers[i].getLatLng().lng });    }

    //création d'un FormData pour transmettre les informations nécessaire vers php
    var informationToGive = new FormData()
    informationToGive.append('city',city)
    informationToGive.append('name', name)
    informationToGive.append('year', year)
    informationToGive.append('markers', JSON.stringify(theMarkers));

    console.log(city,name,year)
    console.log(informationToGive)

    //Utilisation d'ajax pour transmettre les données
    var xhr = new XMLHttpRequest();
    xhr.open('POST', '../Controller/creerParcoursController.php', true);
    xhr.onload = function () {
      if (xhr.readyState == 4 && xhr.status == 200) {
        //affichage de la réponse du serveur
        console.log(xhr.responseText)
      }
    };
    console.log("test")
    xhr.send(informationToGive);
  }





    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);

    var markers = [];
    var routingControl; // Pour stocker le contrôle d'itinéraire

    function addMarker(latlng) {
      var marker = L.marker(latlng).addTo(map);
      markers.push(marker);
      marker.on('click', function () {
        removeMarker(marker);
      });
      updateRoute();
    }

    function removeMarker(marker) {
      map.removeLayer(marker);
      var index = markers.indexOf(marker);
      if (index > -1) {
        markers.splice(index, 1);
      }
      updateRoute();
    }

    function removeLastMarker() {
      if (markers.length > 0) {
        var lastMarker = markers.pop();
        map.removeLayer(lastMarker);
        updateRoute();
      }
    }

    function updateRoute() {
      if (routingControl) {
        map.removeControl(routingControl);
      }

      if (markers.length >= 2) {
        var waypoints = markers.map(function (marker) {
          return marker.getLatLng();
        });

        routingControl = L.Routing.control({
          waypoints: waypoints,
          routeWhileDragging: true,
        }).addTo(map);
      }
    }

    function onMapClick(e) {
      var latlng = e.latlng;
      var latitude = latlng.lat;
      var longitude = latlng.lng;
      addMarker([latitude, longitude]);
    }

    function clearRoute() {
      markers.forEach(function (marker) {
        map.removeLayer(marker);
      });
      markers = [];
      if (routingControl) {
        map.removeControl(routingControl);
      }
    }

    map.on('click', onMapClick);

    document.getElementById('clearRoute').addEventListener('click', clearRoute);
    document.getElementById('removeLastMarker').addEventListener('click', removeLastMarker);
</script>
</body>
</html>
